<p><small style="color:gray;">tl;dr: Complete implementation is at the bottom.</small></p>

<p>Red-Black trees are notorious for being nightmares of pointer manipulation. Instructors will show the theory, but won’t torture their students to implement one. Interviewers will avoid asking about it. They probably couldn’t do it themselves.</p>

<blockquote>
  <p>You should be vaguely familiar with how you might balance a tree. The details, however, are probably unnecessary for the purposes of an interview. 
<small>– Gayle McDowell, Cracking the coding interview</small></p>
</blockquote>

<p>If you’re proficient in a functional language, you owe it to yourself to implement a Red-Black tree. You’ll be one of the few people that can code a Red-Black tree on a whiteboard.</p>

<p>It will make you realize why people are so excited about the whole <em>functional programming</em> thing.</p>

<hr />

<h3 id="what-is-a-red-black-tree">What is a Red-Black Tree?</h3>

<p><img src="/images/redblacktree/tryredblack.jpg" style="width: 100%" /></p>

<p>A Red-Black tree is a balanced binary search tree. Every node is colored red or black. Three rules hold:</p>

<ol>
  <li>No red node has a red child.</li>
  <li>Every path from the root to an empty node contains the same number of black nodes.</li>
  <li>An empty node is always black.</li>
</ol>

<p>Draw a tree with these rules. Notice it’s always relatively-balanced. Try to draw one as unbalanced as possible. You won’t get far.</p>

<p>You can prove the maximum depth of a node is at most \(2\lfloor log(n+1) \rfloor\)</p>

<hr />

<h3 id="implementation">Implementation</h3>
<p>Let’s implement a \(set\) with a Red-Black tree. At minimum we’ll need a <code class="language-plaintext highlighter-rouge">member</code> function and an <code class="language-plaintext highlighter-rouge">insert</code> function.</p>

<hr />

<h4 id="data">Data</h4>

<p>A tree can be empty, or it can be a node with two subtrees, a color, and an element.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">data</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">=</span> <span class="kt">Empty</span> <span class="c1">-- Empty does not need a color, it's always black.</span>
            <span class="o">|</span> <span class="kt">T</span> <span class="kt">Color</span> <span class="p">(</span><span class="kt">Tree</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="p">(</span><span class="kt">Tree</span> <span class="n">a</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Color</span>  <span class="o">=</span> <span class="kt">R</span>
            <span class="o">|</span> <span class="kt">B</span>
</code></pre></div></div>

<hr />

<h4 id="member">Member</h4>

<p>The <code class="language-plaintext highlighter-rouge">member</code> function searches for an element. It’s a binary search.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">member</span> <span class="o">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="n">member</span> <span class="p">(</span><span class="kt">T</span> <span class="kr">_</span> <span class="n">left</span> <span class="n">e</span> <span class="n">right</span><span class="p">)</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="o">==</span> <span class="n">e</span> <span class="o">=</span> <span class="kt">True</span>
                            <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">e</span>  <span class="o">=</span> <span class="n">member</span> <span class="n">left</span> <span class="n">x</span>
                            <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">e</span>  <span class="o">=</span> <span class="n">member</span> <span class="n">right</span> <span class="n">x</span>
<span class="n">member</span> <span class="kt">Empty</span>              <span class="kr">_</span>          <span class="o">=</span> <span class="kt">False</span>
</code></pre></div></div>

<hr />

<h4 id="insert">Insert</h4>

<p>The <code class="language-plaintext highlighter-rouge">insert</code> function uses the function <code class="language-plaintext highlighter-rouge">build</code>, which is a constructor that makes sure the node is balanced.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">insert</span> <span class="o">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span>
<span class="n">insert</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="kr">let</span> <span class="kt">T</span> <span class="kr">_</span> <span class="n">a</span> <span class="n">y</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ins</span> <span class="n">s</span>
             <span class="kr">in</span>  <span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">y</span> <span class="n">b</span>
        <span class="kr">where</span>
          <span class="n">ins</span> <span class="n">s'</span><span class="o">@</span><span class="p">(</span><span class="kt">T</span> <span class="n">color</span> <span class="n">a'</span> <span class="n">y'</span> <span class="n">b'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y'</span>    <span class="o">=</span> <span class="n">build</span> <span class="n">color</span> <span class="p">(</span><span class="n">ins</span> <span class="n">a'</span><span class="p">)</span> <span class="n">y'</span> <span class="n">b'</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y'</span>    <span class="o">=</span> <span class="n">build</span> <span class="n">color</span> <span class="n">a'</span> <span class="n">y'</span> <span class="p">(</span><span class="n">ins</span> <span class="n">b'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">otherwise</span> <span class="o">=</span> <span class="n">s'</span>
          <span class="n">ins</span> <span class="kt">Empty</span>             <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="kt">Empty</span> <span class="n">x</span> <span class="kt">Empty</span>
</code></pre></div></div>

<p>There are four cases when <code class="language-plaintext highlighter-rouge">build</code> needs to adjust a node. It detects the case when a black parent has a red child with a red child. It shifts the nodes around to fix it. The solution is the same in every case. (Notice the right hand sides of <code class="language-plaintext highlighter-rouge">build</code> are the same).</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">build</span> <span class="o">::</span> <span class="kt">Color</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span>
<span class="n">build</span> <span class="kt">B</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="n">c</span><span class="p">)</span> <span class="n">z</span> <span class="n">d</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="n">c</span><span class="p">))</span> <span class="n">z</span> <span class="n">d</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="n">c</span><span class="p">)</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">))</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="n">color</span> <span class="n">left</span> <span class="n">x</span> <span class="n">right</span>          <span class="o">=</span> <span class="kt">T</span> <span class="n">color</span> <span class="n">left</span> <span class="n">x</span> <span class="n">right</span>
</code></pre></div></div>

<p><img src="/images/redblacktree/balance.jpg" style="width: 100%" /></p>

<h3 id="afterwards">Afterwards</h3>

<p>That’s it. You have a Red-Black tree.</p>

<p>If you want to learn more, read <a href="http://amzn.to/1Kdg2iD"><em>Purely Functional Data Structures</em></a> by Chris Okasaki. I stole most of my implementation from this book. The <code class="language-plaintext highlighter-rouge">build</code> diagram is also from the book.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">RedBlackSet</span><span class="p">(</span> <span class="n">empty</span>
                  <span class="p">,</span> <span class="n">member</span>
                  <span class="p">,</span> <span class="n">insert</span>
                  <span class="p">)</span> <span class="kr">where</span>

<span class="kr">data</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">=</span> <span class="kt">Empty</span>
            <span class="o">|</span> <span class="kt">T</span> <span class="kt">Color</span> <span class="p">(</span><span class="kt">Tree</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="p">(</span><span class="kt">Tree</span> <span class="n">a</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Color</span>  <span class="o">=</span> <span class="kt">R</span>
            <span class="o">|</span> <span class="kt">B</span>

<span class="n">empty</span> <span class="o">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="kt">Tree</span> <span class="n">a</span>
<span class="n">empty</span> <span class="o">=</span> <span class="kt">Empty</span>

<span class="n">member</span> <span class="o">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
<span class="n">member</span> <span class="p">(</span><span class="kt">T</span> <span class="kr">_</span> <span class="n">left</span> <span class="n">e</span> <span class="n">right</span><span class="p">)</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="o">==</span> <span class="n">e</span> <span class="o">=</span> <span class="kt">True</span>
                            <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">e</span>  <span class="o">=</span> <span class="n">member</span> <span class="n">left</span> <span class="n">x</span>
                            <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">e</span>  <span class="o">=</span> <span class="n">member</span> <span class="n">right</span> <span class="n">x</span>
<span class="n">member</span> <span class="kt">Empty</span> <span class="kr">_</span>                       <span class="o">=</span> <span class="kt">False</span>

<span class="n">insert</span> <span class="o">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span>
<span class="n">insert</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="kr">let</span> <span class="kt">T</span> <span class="kr">_</span> <span class="n">a</span> <span class="n">y</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ins</span> <span class="n">s</span>
             <span class="kr">in</span>  <span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">y</span> <span class="n">b</span>
        <span class="kr">where</span>
          <span class="n">ins</span> <span class="n">s'</span><span class="o">@</span><span class="p">(</span><span class="kt">T</span> <span class="n">color</span> <span class="n">a'</span> <span class="n">y'</span> <span class="n">b'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y'</span>    <span class="o">=</span> <span class="n">build</span> <span class="n">color</span> <span class="p">(</span><span class="n">ins</span> <span class="n">a'</span><span class="p">)</span> <span class="n">y'</span> <span class="n">b'</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y'</span>    <span class="o">=</span> <span class="n">build</span> <span class="n">color</span> <span class="n">a'</span> <span class="n">y'</span> <span class="p">(</span><span class="n">ins</span> <span class="n">b'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">otherwise</span> <span class="o">=</span> <span class="n">s'</span>
          <span class="n">ins</span> <span class="kt">Empty</span>             <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="kt">Empty</span> <span class="n">x</span> <span class="kt">Empty</span>

<span class="n">build</span> <span class="o">::</span> <span class="kt">Color</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kt">Tree</span> <span class="n">a</span>
<span class="n">build</span> <span class="kt">B</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="n">c</span><span class="p">)</span> <span class="n">z</span> <span class="n">d</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="n">c</span><span class="p">))</span> <span class="n">z</span> <span class="n">d</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="n">c</span><span class="p">)</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">b</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">R</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">))</span> <span class="o">=</span> <span class="kt">T</span> <span class="kt">R</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">a</span> <span class="n">x</span> <span class="n">b</span><span class="p">)</span> <span class="n">y</span> <span class="p">(</span><span class="kt">T</span> <span class="kt">B</span> <span class="n">c</span> <span class="n">z</span> <span class="n">d</span><span class="p">)</span>
<span class="n">build</span> <span class="n">color</span> <span class="n">left</span> <span class="n">x</span> <span class="n">right</span>          <span class="o">=</span> <span class="kt">T</span> <span class="n">color</span> <span class="n">left</span> <span class="n">x</span> <span class="n">right</span>
</code></pre></div></div>
